trigger: none

pool:
  vmImage: ubuntu-latest

stages:
- stage: validate
  jobs:
  - job: SecurityScan
    displayName: 'Run OPA Policy Checks'
    pool:
      vmImage: 'ubuntu-latest'
    steps:
    - script: |
        # Install conftest using Homebrew
        brew install conftest

        # Run the automatic policy generation with conftest
        conftest generate -p policy-path -o OPA_policy.rego

        # Print value of $(Build.SourcesDirectory)
        echo "Build.SourcesDirectory: $(Build.SourcesDirectory)"

        # Print directory contents
        ls -la $(Build.SourcesDirectory)

        # Run conftest against Terraform code using generated policy
        conftest test -p OPA_policy.rego $(Build.SourcesDirectory)

        # Capture the exit code of conftest
        CONFTEST_EXIT_CODE=$?

        # Check the exit code and exit accordingly
        if [ $CONFTEST_EXIT_CODE -eq 0 ]; then
          echo "OPA policy checks passed successfully."
        else
          echo "OPA policy checks failed with violations."
        fi
        exit $CONFTEST_EXIT_CODE
      displayName: 'Run OPA Policy Checks'
